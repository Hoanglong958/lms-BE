<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Test Chat V2 REST & WebSocket</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    fieldset { margin-bottom: 16px; }
    input, select, button, textarea { margin: 4px 0; padding: 6px 8px; }
    label { display: block; font-weight: 600; margin-top: 6px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .col { flex: 1 1 260px; min-width: 240px; }
    pre { background: #111; color: #0f0; padding: 10px; white-space: pre-wrap; }
    .badge { display: inline-block; padding: 2px 6px; background: #eef; border-radius: 4px; margin-left: 6px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
  <h2>Frontend test Chat V2 (1-1 & Group)</h2>

  <fieldset>
    <legend>Cấu hình</legend>
    <div class="row">
      <div class="col">
        <label>Base URL (REST)</label>
        <input id="baseUrl" value="http://localhost:3901" style="width: 100%" />
        <small>Swagger UI: <span id="swaggerUrl">http://localhost:3901/docs</span></small>
      </div>
      <div class="col">
        <label>Bearer Token (tùy chọn)</label>
        <input id="token" placeholder="JWT token" style="width: 100%" />
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Phòng & Thành viên</legend>
    <div class="row">
      <div class="col">
        <label>User ID 1</label>
        <input id="userId1" value="1001" />
      </div>
      <div class="col">
        <label>User ID 2</label>
        <input id="userId2" value="2001" />
      </div>
      <div class="col">
        <label>Current User ID</label>
        <input id="currentUserId" value="1001" />
      </div>
      <div class="col">
        <label>Room ID (UUID)</label>
        <input id="roomId" placeholder="vd: UUID" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <button onclick="oneToOne()">Tạo/Lấy phòng 1-1</button>
        <button onclick="createGroup()">Tạo nhóm</button>
        <button onclick="myRooms()">Danh sách phòng của tôi</button>
      </div>
      <div class="col">
        <input id="newMemberIds" placeholder="memberIds csv, vd: 3001,3002" style="width:100%" />
        <button onclick="addMembers()">Thêm thành viên</button>
        <input id="removeMemberId" placeholder="memberId" />
        <button onclick="removeMember()">Xóa thành viên</button>
        <button onclick="leaveRoom()">Rời nhóm</button>
      </div>
      <div class="col">
        <input id="newName" placeholder="Tên mới" />
        <button onclick="renameRoom()">Đổi tên</button>
        <input id="newAvatar" placeholder="URL avatar" />
        <button onclick="updateAvatar()">Đổi avatar</button>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>WebSocket/STOMP</legend>
    <div class="row">
      <div class="col">
        <label>WS URL</label>
        <input id="wsUrl" value="ws://localhost:3901/ws" style="width:100%" />
        <small>Gợi ý: ws://host:port/ws hoặc http(s)://host:port/ws (SockJS cũng OK)</small>
      </div>
      <div class="col">
        <label>Destination gửi tin (send)</label>
        <input id="sendDest" value="/app/chat.sendMessage" style="width:100%" />
        <small>Ví dụ: /app/chat.sendMessage</small>
      </div>
      <div class="col">
        <label>Typing dest</label>
        <input id="typingDest" value="/app/chat.typing" style="width:100%" />
      </div>
      <div class="col">
        <label>Topic subscribe</label>
        <input id="subTopic" value="/topic/rooms/{roomId}" style="width:100%" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <button onclick="connectWs()">Kết nối WS</button>
        <button onclick="disconnectWs()">Ngắt kết nối</button>
        <span id="wsState" class="badge">DISCONNECTED</span>
      </div>
      <div class="col">
        <button onclick="typingWs()">Typing...</button>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label>Nội dung tin nhắn</label>
        <input id="msgContent" style="width:100%" placeholder="Nhập nội dung..." />
      </div>
      <div class="col">
        <label>Sender ID</label>
        <input id="senderId" value="1001" />
      </div>
      <div class="col">
        <label>Loại tin</label>
        <select id="msgType">
          <option value="TEXT">TEXT</option>
          <option value="IMAGE">IMAGE</option>
          <option value="FILE">FILE</option>
        </select>
      </div>
    </div>
    <div>
      <button onclick="sendMessageWs()">Gửi tin nhắn (WS)</button>
      <button onclick="sendMessageRest()">Gửi tin nhắn (REST)</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Tin nhắn REST</legend>
    <div class="row">
      <div class="col">
        <button onclick="loadMessages()">Lịch sử (REST)</button>
        <button onclick="countUnread()">Đếm chưa đọc</button>
      </div>
      <div class="col">
        <input id="keyword" placeholder="keyword" />
        <button onclick="searchMessages()">Tìm kiếm</button>
      </div>
    </div>
  </fieldset>

  <h3>Kết quả</h3>
  <pre id="output"></pre>

<script>
  let stompClient = null;
  let wsSubscription = null;

  function log(obj) {
    const out = document.getElementById('output');
    const line = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2);
    out.textContent += `\n${line}`;
    out.scrollTop = out.scrollHeight;
  }
  function setWsState(text) {
    document.getElementById('wsState').textContent = text;
  }
  function authHeader() {
    const token = document.getElementById('token').value.trim();
    return token ? { 'Authorization': `Bearer ${token}` } : {};
    }
  function baseUrl() {
    return document.getElementById('baseUrl').value.trim().replace(/\/$/, '');
  }

  // ===== REST helpers (Chat V2) =====
  async function oneToOne() {
    const userId1 = document.getElementById('userId1').value.trim();
    const userId2 = document.getElementById('userId2').value.trim();
    const url = `${baseUrl()}/api/chat/rooms/one-to-one`;
    try {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify({ userId1: Number(userId1), userId2: Number(userId2) }) });
      const data = await res.json();
      document.getElementById('roomId').value = data.id;
      log({ action: 'oneToOne', data });
    } catch (e) { log(e); }
  }

  async function createGroup() {
    const name = document.getElementById('newName').value.trim() || 'New Group';
    const createdBy = Number(document.getElementById('currentUserId').value.trim());
    const memberCsv = document.getElementById('newMemberIds').value.trim();
    const memberIds = memberCsv ? memberCsv.split(',').map(x => Number(x.trim())) : [];
    const url = `${baseUrl()}/api/chat/rooms/group`;
    try {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify({ name, avatar: null, memberIds, createdBy }) });
      const data = await res.json();
      document.getElementById('roomId').value = data.id;
      log({ action: 'createGroup', data });
    } catch (e) { log(e); }
  }

  async function addMembers() {
    const roomId = document.getElementById('roomId').value.trim();
    const operatorUserId = Number(document.getElementById('currentUserId').value.trim());
    const memberCsv = document.getElementById('newMemberIds').value.trim();
    const memberIds = memberCsv ? memberCsv.split(',').map(x => Number(x.trim())) : [];
    const url = `${baseUrl()}/api/chat/rooms/${roomId}/members?operatorUserId=${operatorUserId}`;
    try {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify({ memberIds }) });
      log({ action: 'addMembers', status: res.status });
    } catch (e) { log(e); }
  }

  async function removeMember() {
    const roomId = document.getElementById('roomId').value.trim();
    const operatorUserId = Number(document.getElementById('currentUserId').value.trim());
    const memberId = Number(document.getElementById('removeMemberId').value.trim());
    const url = `${baseUrl()}/api/chat/rooms/${roomId}/members/${memberId}?operatorUserId=${operatorUserId}`;
    try { const res = await fetch(url, { method: 'DELETE', headers: { ...authHeader() } }); log({ action: 'removeMember', status: res.status }); } catch (e) { log(e); }
  }

  async function leaveRoom() {
    const roomId = document.getElementById('roomId').value.trim();
    const memberId = Number(document.getElementById('currentUserId').value.trim());
    const url = `${baseUrl()}/api/chat/rooms/${roomId}/leave?memberId=${memberId}`;
    try { const res = await fetch(url, { method: 'POST', headers: { ...authHeader() } }); log({ action: 'leaveRoom', status: res.status }); } catch (e) { log(e); }
  }

  async function renameRoom() {
    const roomId = document.getElementById('roomId').value.trim();
    const operatorUserId = Number(document.getElementById('currentUserId').value.trim());
    const name = document.getElementById('newName').value.trim();
    const url = `${baseUrl()}/api/chat/rooms/${roomId}/name?operatorUserId=${operatorUserId}`;
    try { const res = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify({ name }) }); log({ action: 'renameRoom', status: res.status }); } catch (e) { log(e); }
  }

  async function updateAvatar() {
    const roomId = document.getElementById('roomId').value.trim();
    const operatorUserId = Number(document.getElementById('currentUserId').value.trim());
    const avatarUrl = document.getElementById('newAvatar').value.trim();
    const url = `${baseUrl()}/api/chat/rooms/${roomId}/avatar?operatorUserId=${operatorUserId}`;
    try { const res = await fetch(url, { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify({ avatarUrl }) }); log({ action: 'updateAvatar', status: res.status }); } catch (e) { log(e); }
  }

  async function myRooms() {
    const userId = Number(document.getElementById('currentUserId').value.trim());
    const url = `${baseUrl()}/api/chat/rooms/me?userId=${userId}`;
    try { const res = await fetch(url, { headers: { ...authHeader() } }); const data = await res.json(); log({ action: 'myRooms', data }); } catch (e) { log(e); }
  }

  async function loadMessages() {
    const roomId = document.getElementById('roomId').value.trim();
    const url = `${baseUrl()}/api/chat/messages/history?roomId=${roomId}&page=0&size=30`;
    try { const res = await fetch(url, { headers: { ...authHeader() } }); const data = await res.json(); log({ action: 'history', data }); } catch (e) { log(e); }
  }

  async function countUnread() {
    const roomId = document.getElementById('roomId').value.trim();
    const userId = Number(document.getElementById('currentUserId').value.trim());
    const url = `${baseUrl()}/api/chat/rooms/${roomId}/unread-count?userId=${userId}`;
    try { const res = await fetch(url, { headers: { ...authHeader() } }); const data = await res.json(); log({ action: 'unread', data }); } catch (e) { log(e); }
  }

  async function searchMessages() {
    const roomId = document.getElementById('roomId').value.trim();
    const keyword = document.getElementById('keyword').value.trim();
    const url = `${baseUrl()}/api/chat/messages/search?roomId=${roomId}&keyword=${encodeURIComponent(keyword)}&page=0&size=20`;
    try { const res = await fetch(url, { headers: { ...authHeader() } }); const data = await res.json(); log({ action: 'search', data }); } catch (e) { log(e); }
  }

  async function sendMessageRest() {
    const roomId = document.getElementById('roomId').value.trim();
    const senderId = Number(document.getElementById('senderId').value.trim());
    const content = document.getElementById('msgContent').value.trim();
    const type = document.getElementById('msgType').value;
    const url = `${baseUrl()}/api/chat/messages`;
    try {
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify({ roomId, senderId, content, type }) });
      const data = await res.json(); log({ action: 'sendMessageRest', data });
    } catch (e) { log(e); }
  }

  // ===== WebSocket/STOMP =====
  function connectWs() {
    const wsUrl = document.getElementById('wsUrl').value.trim();
    // Dùng SockJS để tương thích
    let socket;
    if (wsUrl.startsWith('http://') || wsUrl.startsWith('https://')) {
      socket = new SockJS(wsUrl);
    } else {
      // ws:// hoặc wss:// có thể dùng trực tiếp với WebSocket (stomp.js vẫn hỗ trợ)
      socket = new WebSocket(wsUrl);
    }
    stompClient = Stomp.over(socket);
    stompClient.debug = function(){}; // tắt log ồn

    stompClient.connect({}, () => {
      setWsState('CONNECTED');
      log('WS connected');

      // Tự subscribe nếu có roomId
      const topicTpl = document.getElementById('subTopic').value.trim();
      const roomId = document.getElementById('roomId').value.trim();
      if (topicTpl && roomId) {
        const topic = topicTpl.replace('{roomId}', roomId);
        if (wsSubscription) wsSubscription.unsubscribe();
        wsSubscription = stompClient.subscribe(topic, (message) => {
          try { log({ topic, payload: JSON.parse(message.body) }); }
          catch { log({ topic, payload: message.body }); }
        });
        log(`Subscribed to ${topic}`);
      }
    }, (err) => {
      setWsState('ERROR');
      log(err);
    });
  }

  function disconnectWs() {
    if (wsSubscription) { try { wsSubscription.unsubscribe(); } catch {} wsSubscription = null; }
    if (stompClient && stompClient.connected) {
      stompClient.disconnect(() => {
        setWsState('DISCONNECTED');
        log('WS disconnected');
      });
    } else {
      setWsState('DISCONNECTED');
    }
  }

  function typingWs() {
    if (!stompClient || !stompClient.connected) { return log('WS not connected'); }
    const typingDest = document.getElementById('typingDest').value.trim();
    const roomId = document.getElementById('roomId').value.trim();
    const currentUserId = Number(document.getElementById('currentUserId').value.trim());
    const payload = { roomId, senderId: currentUserId };
    stompClient.send(typingDest, {}, JSON.stringify(payload));
    log({ action: 'typing', typingDest, payload });
  }

  function sendMessageWs() {
    if (!stompClient || !stompClient.connected) { return log('WS not connected'); }
    const sendDest = document.getElementById('sendDest').value.trim();
    const roomId = document.getElementById('roomId').value.trim();
    const senderId = Number(document.getElementById('senderId').value.trim());
    const content = document.getElementById('msgContent').value.trim();
    const type = document.getElementById('msgType').value;
    const payload = { roomId, senderId, content, type };
    stompClient.send(sendDest, {}, JSON.stringify(payload));
    log({ action: 'sendMessageWs', sendDest, payload });
  }

  // Cập nhật link swagger theo baseUrl
  document.getElementById('baseUrl').addEventListener('input', (e) => {
    const v = e.target.value.trim().replace(/\/$/, '');
    document.getElementById('swaggerUrl').textContent = `${v}/docs`;
  });
</script>
</body>
</html>
